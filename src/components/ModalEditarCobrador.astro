---
import { Icon } from 'astro-icon/components';

interface Props {
  username: string;
}

const { username } = Astro.props;
---

<div id="modal-editar-cobrador" class="fixed inset-0 z-[110] hidden">
  <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-md" id="close-edit-bg"></div>
  
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6">
    <div class="bg-white rounded-[3rem] shadow-2xl overflow-hidden border border-slate-200">
      
      <div class="bg-blue-600 p-8 text-white">
        <h3 class="text-2xl font-black tracking-tighter">Editar Perfil</h3>
        <p class="text-blue-200 text-[10px] font-bold uppercase tracking-widest mt-1">Usuario: {username}</p>
      </div>

      <form id="form-edit-cobrador" class="p-10 space-y-6">
        <div class="space-y-2">
          <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Nombre Completo</label>
          <input type="text" id="edit-nombre" name="nombre" class="w-full bg-slate-50 border-2 border-transparent focus:border-blue-600 rounded-2xl px-6 py-4 outline-none font-bold transition-all" required>
        </div>

        <div class="space-y-2">
          <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Zona de Trabajo</label>
          <input type="text" id="edit-zona" name="zona" class="w-full bg-slate-50 border-2 border-transparent focus:border-blue-600 rounded-2xl px-6 py-4 outline-none font-bold transition-all" required>
        </div>

        <div class="space-y-2">
          <label class="text-[10px] font-black uppercase text-slate-400 ml-2">Nueva Contraseña (Opcional)</label>
          <input type="password" name="password" placeholder="Dejar en blanco para no cambiar" class="w-full bg-slate-50 border-2 border-transparent focus:border-blue-600 rounded-2xl px-6 py-4 outline-none font-bold transition-all">
        </div>

        <div class="flex gap-3 pt-4">
            <button type="button" id="btn-cancel-edit" class="flex-1 bg-slate-100 text-slate-500 py-4 rounded-2xl font-black text-xs uppercase hover:bg-slate-200 transition-all">Cancelar</button>
            <button type="submit" class="flex-1 bg-blue-600 text-white py-4 rounded-2xl font-black text-xs uppercase shadow-lg shadow-blue-100 hover:bg-blue-700 transition-all">Guardar Cambios</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script define:vars={{ username }}>
  const modal = document.getElementById('modal-editar-cobrador');
  const form = document.getElementById('form-edit-cobrador');
  
  // URL de producción configurada directamente
  const API_URL = 'https://cobrodigital.onrender.com';

  const cerrarModal = () => {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  };

  if (document.getElementById('close-edit-bg')) document.getElementById('close-edit-bg').onclick = cerrarModal;
  if (document.getElementById('btn-cancel-edit')) document.getElementById('btn-cancel-edit').onclick = cerrarModal;

  form.onsubmit = async (e) => {
    e.preventDefault();
    const formData = new FormData(form);
    const data = Object.fromEntries(formData);

    try {
      // Reemplazamos localhost por la URL de Render
      const res = await fetch(`${API_URL}/cobradores/${username}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          username: username,
          nombre: data.nombre,
          zona: data.zona,
          password: data.password || "",
        })
      });

      if (res.ok) {
        alert("✅ Perfil actualizado");
        window.location.reload();
      } else {
        const error = await res.json();
        alert("❌ Error: " + (error.detail || "No se pudo actualizar"));
      }
    } catch (err) {
      alert("❌ Error de conexión con el servidor");
    }
  };
</script>