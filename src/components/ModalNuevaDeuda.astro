---
import { Icon } from 'astro-icon/components';

interface Props {
  clienteId: string;
}

const { clienteId } = Astro.props;
---

<div id="modal-nueva-deuda" class="fixed inset-0 z-[100] hidden">
  <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm" id="close-deuda-bg"></div>
  <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-6">
    <div class="bg-white rounded-[3rem] shadow-2xl border border-slate-200 overflow-hidden animate-in fade-in zoom-in duration-300">
      
      <div class="bg-slate-900 p-8 text-white relative">
        <button id="close-deuda-btn" class="absolute top-6 right-6 hover:rotate-90 transition-transform">
          <Icon name="lucide:x" class="w-8 h-8" />
        </button>
        <div class="flex items-center gap-4">
          <div class="bg-emerald-500 p-3 rounded-2xl">
            <Icon name="lucide:refresh-cw" class="w-8 h-8 text-white" />
          </div>
          <div>
            <h3 class="text-2xl font-black tracking-tight leading-none">Nueva Deuda</h3>
            <p class="text-slate-400 text-[10px] mt-2 uppercase font-bold tracking-widest">Reactivar Financiamiento</p>
          </div>
        </div>
      </div>

      <form class="p-10 space-y-6" id="form-nueva-deuda">
        <div class="space-y-2">
          <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Nuevo Capital</label>
          <input 
            type="number" name="saldo" 
            placeholder="Ej: 5000"
            class="w-full px-8 py-5 bg-slate-50 border-2 border-transparent rounded-2xl text-2xl font-black focus:bg-white focus:border-emerald-500 outline-none transition-all"
            required
          />
        </div>

        <div class="space-y-2">
          <label class="block text-[10px] font-black uppercase tracking-widest text-slate-400 ml-4">Nueva Tasa (%)</label>
          <input 
            type="number" name="interes" 
            placeholder="Ej: 20"
            class="w-full px-8 py-5 bg-slate-50 border-2 border-transparent rounded-2xl text-2xl font-black focus:bg-white focus:border-emerald-500 outline-none transition-all"
            required
          />
        </div>

        <button type="submit" id="btn-confirmar-deuda" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white py-6 rounded-[2rem] font-black text-xl transition-all active:scale-95 shadow-xl shadow-emerald-100">
          REACTIVAR CLIENTE
        </button>
      </form>
    </div>
  </div>
</div>

<script define:vars={{ clienteId }}>
  const modal = document.getElementById('modal-nueva-deuda');
  const btnAbrir = document.getElementById('btn-nueva-deuda');
  const btnCerrar = document.getElementById('close-deuda-btn');
  const bgCerrar = document.getElementById('close-deuda-bg');
  const form = document.getElementById('form-nueva-deuda');

  // URL de producción de Render
  const API_URL = 'https://cobrodigital.onrender.com';

  btnAbrir?.addEventListener('click', () => {
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  });

  const cerrar = () => {
    modal.classList.add('hidden');
    document.body.style.overflow = 'auto';
  };

  [btnCerrar, bgCerrar].forEach(el => el?.addEventListener('click', cerrar));

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = Object.fromEntries(new FormData(form));
    
    try {
      // Reemplazado localhost por la URL de Render
      const res = await fetch(`${API_URL}/clientes/${clienteId}/nueva-deuda`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          saldo: Number(data.saldo),
          interes: Number(data.interes),
          // Obtenemos los datos actuales del DOM para completar el esquema
          nombre: document.getElementById('view-nombre')?.innerText || "",
          barrio: document.getElementById('view-barrio')?.innerText || "",
          direccion: document.getElementById('view-direccion')?.innerText || "",
          telefono: document.getElementById('view-telefono')?.innerText || "",
          cobrador_id: "system" 
        })
      });

      if (res.ok) {
        alert("✅ Cliente reactivado correctamente");
        window.location.reload();
      } else {
        const errorData = await res.json();
        alert("❌ Error: " + (errorData.detail || "No se pudo reactivar la deuda"));
      }
    } catch (err) {
      console.error(err);
      alert("❌ Error de conexión con el servidor");
    }
  });
</script>