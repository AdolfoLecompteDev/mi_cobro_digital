---
import Layout from '../layouts/Layout.astro';
import { Icon } from 'astro-icon/components';
import ResumenRapido from '../components/ResumenRapido.astro'; 
---

<Layout title="Panel de Control - CobroDigital">
  <nav class="max-w-7xl mx-auto px-6 pt-8 flex justify-between items-center">
    <div id="user-tag" class="flex items-center gap-3 bg-white px-5 py-2.5 rounded-2xl border border-slate-100 shadow-sm">
        <div id="role-icon" class="w-2.5 h-2.5 rounded-full animate-pulse"></div>
        <span id="role-text" class="text-[10px] font-black uppercase tracking-[0.2em] text-slate-500">Verificando...</span>
    </div>

    <button id="logout-btn" class="group flex items-center gap-2 text-slate-400 hover:text-red-500 font-black text-[10px] uppercase tracking-[0.2em] transition-all">
      <div class="bg-slate-100 group-hover:bg-red-50 p-2.5 rounded-xl transition-colors">
        <Icon name="lucide:log-out" class="w-4 h-4" />
      </div>
      Finalizar Sesión
    </button>
  </nav>

  <div class="max-w-7xl mx-auto px-6 py-10">
    
    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-12 gap-8">
      <div>
        <h1 class="text-5xl font-black text-slate-900 tracking-tighter flex items-center gap-4">
          <div class="bg-blue-600 p-3 rounded-[1.2rem] shadow-lg shadow-blue-200">
            <Icon name="lucide:layout-grid" class="text-white w-7 h-7" /> 
          </div>
          Central
        </h1>
        <p class="text-slate-500 font-bold mt-2 ml-1 uppercase text-[9px] tracking-[0.3em]">Operaciones de Cartera en Tiempo Real</p>
      </div>
      
      <div class="flex flex-wrap gap-4">
        <a id="btn-nuevo-cobrador" href="/nuevo-cobrador" class="hidden bg-slate-100 hover:bg-slate-200 text-slate-900 px-6 py-4 rounded-2xl font-black flex items-center gap-3 transition-all active:scale-95 text-xs uppercase tracking-widest group">
          <Icon name="lucide:shield-plus" class="w-4 h-4 text-blue-600" /> 
          Personal
        </a>

        <a href="/nuevo-cliente" class="bg-blue-600 hover:bg-blue-700 text-white px-8 py-4 rounded-2xl font-black flex items-center gap-3 shadow-xl shadow-blue-100 transition-all active:scale-95 text-xs uppercase tracking-widest group">
          <Icon name="lucide:plus-circle" class="w-5 h-5" /> 
          Registrar Crédito
        </a>
      </div>
    </div>

    <div id="stats-container" class="hidden mb-16 animate-in fade-in duration-1000">
      <div class="flex items-center gap-3 mb-6 pl-1">
        <div class="w-1.5 h-4 bg-emerald-500 rounded-full"></div>
        <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Balance de Utilidades</h2>
      </div>
      <ResumenRapido />
    </div>

    <div id="cobradores-container" class="hidden mb-16">
        <div class="mb-6 flex items-center gap-3 pl-1">
            <div class="w-1.5 h-4 bg-blue-600 rounded-full"></div>
            <h2 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Cobradores en Ruta</h2>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4" id="lista-cobradores">
            </div>
    </div>

    <div class="mb-6 flex items-center justify-between px-1">
        <div class="flex items-center gap-3">
            <div class="w-1.5 h-4 bg-slate-800 rounded-full"></div>
            <h2 id="list-title" class="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Cargando Cartera...</h2>
        </div>
        <div id="client-badge" class="hidden bg-blue-50 text-blue-600 text-[9px] font-black px-3 py-1 rounded-full uppercase tracking-tighter border border-blue-100">
            0 Registros
        </div>
    </div>

    <div id="grid-clientes" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 pb-20">
        {[1,2,3,4,5,6,7,8].map(() => (
            <div class="bg-white h-64 rounded-[2rem] border border-slate-100 animate-pulse shadow-sm"></div>
        ))}
    </div>
  </div>
</Layout>

<script>
  import { navigate } from 'astro:transitions/client';

  const API_URL = 'https://cobrodigital.onrender.com';

  let isAuthenticated = false;
  let user: any = null;

  // 1. VERIFICACIÓN DE SEGURIDAD (SIN LOOP)
  function checkAuth() {
    const session = localStorage.getItem('currentUser');
    
    if (!session || session === 'undefined' || session === 'null') {
      console.log("No hay sesión, redirigiendo a login...");
      navigate('/');
      return false;
    }

    try {
      user = JSON.parse(session);
      
      if (!user || !user.username) {
        console.log("Datos de usuario inválidos");
        localStorage.removeItem('currentUser');
        navigate('/');
        return false;
      }

      isAuthenticated = true;
      return true;
    } catch (e) {
      console.error("Error al verificar autenticación:", e);
      localStorage.removeItem('currentUser');
      navigate('/');
      return false;
    }
  }

  // 2. CONFIGURACIÓN DE UI
  function setupUI() {
    if (!user) return;

    const roleText = document.getElementById('role-text');
    const roleIcon = document.getElementById('role-icon');
    const title = document.getElementById('list-title');
    const statsCont = document.getElementById('stats-container');
    const cobradoresCont = document.getElementById('cobradores-container');
    const btnCobrador = document.getElementById('btn-nuevo-cobrador');

    if (user.role === 'admin') {
      statsCont?.classList.remove('hidden');
      cobradoresCont?.classList.remove('hidden');
      btnCobrador?.classList.remove('hidden');
      if (roleText) roleText.innerText = "Admin Master";
      roleIcon?.classList.add('bg-emerald-500');
      if (title) title.innerText = "Cartera Global";
    } else {
      if (roleText) roleText.innerText = `Ruta: ${user.nombre || user.username}`;
      roleIcon?.classList.add('bg-blue-500');
      if (title) title.innerText = "Mi Listado de Cobro";
    }
  }

  // 3. OBTENCIÓN DE DATOS
  async function fetchData() {
    if (!isAuthenticated || !user || !user.username) return;

    const grid = document.getElementById('grid-clientes');
    const badge = document.getElementById('client-badge');

    try {
      const urlClientes = user.role === 'admin' 
        ? `${API_URL}/clientes` 
        : `${API_URL}/clientes?cobrador_id=${user.username}`;
      
      const [resClientes, resCobs] = await Promise.all([
        fetch(urlClientes),
        user.role === 'admin' ? fetch(`${API_URL}/cobradores`) : Promise.resolve(null)
      ]);

      if (!resClientes.ok) throw new Error("Error API");

      const clientes = await resClientes.json();
      renderClientes(clientes);

      if (badge) {
        badge.classList.remove('hidden');
        badge.innerText = `${clientes.length} Registro${clientes.length !== 1 ? 's' : ''}`;
      }

      if (resCobs && resCobs.ok) {
        const cobradores = await resCobs.json();
        renderCobradores(cobradores);
      }
    } catch (error) {
      console.error("Error cargando datos:", error);
      if (grid) {
        grid.innerHTML = `
          <div class="col-span-full text-center py-20">
            <div class="text-red-500 font-bold mb-2">Error al cargar datos</div>
            <button onclick="location.reload()" class="text-blue-600 text-sm hover:underline">Reintentar</button>
          </div>
        `;
      }
    }
  }

  // 4. RENDER CLIENTES CON ENLACES
  function renderClientes(lista: any[]) {
    const grid = document.getElementById('grid-clientes');
    if (!grid) return;

    if (lista.length === 0) {
      grid.innerHTML = `
        <div class="col-span-full text-center py-20">
          <div class="text-slate-400 font-bold text-sm">No hay clientes registrados</div>
        </div>
      `;
      return;
    }

    // ✅ AGREGADO: Enlaces <a href="/cliente/ID"> para navegar a cada cliente
    grid.innerHTML = lista.map(cliente => `
      <a href="/cliente/${cliente.id}" class="group bg-white rounded-[2rem] border border-slate-100 p-6 shadow-sm hover:shadow-xl hover:border-blue-200 transition-all block">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 class="font-black text-slate-900 text-lg group-hover:text-blue-600 transition-colors">${cliente.nombre}</h3>
            <p class="text-slate-400 text-xs font-bold uppercase tracking-wider">${cliente.direccion || cliente.barrio || 'Sin dirección'}</p>
          </div>
          <div class="bg-slate-100 group-hover:bg-blue-50 p-2 rounded-xl transition-colors">
            <svg class="w-5 h-5 text-slate-600 group-hover:text-blue-600 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
        </div>
        <div class="space-y-2">
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold text-slate-400">Teléfono</span>
            <span class="text-sm font-black text-slate-900">${cliente.telefono || 'N/A'}</span>
          </div>
          <div class="flex justify-between items-center">
            <span class="text-xs font-bold text-slate-400">Saldo</span>
            <span class="text-lg font-black text-red-600 group-hover:text-blue-600 transition-colors">$${Number(cliente.saldo || 0).toLocaleString()}</span>
          </div>
        </div>
        <div class="mt-4 pt-4 border-t border-slate-100 flex items-center justify-between">
          <span class="text-[9px] font-black uppercase tracking-widest ${cliente.activo ? 'text-emerald-500' : 'text-slate-300'}">
            ${cliente.activo ? '● Activo' : '● Finalizado'}
          </span>
          <span class="text-xs font-bold text-blue-600 opacity-0 group-hover:opacity-100 transition-opacity">
            Ver detalles →
          </span>
        </div>
      </a>
    `).join('');
  }

  // 5. RENDER COBRADORES CON ENLACES
  function renderCobradores(lista: any[]) {
    const container = document.getElementById('lista-cobradores');
    if (!container) return;

    // ✅ AGREGADO: Enlaces <a href="/cobrador/USERNAME"> para navegar a cada cobrador
    container.innerHTML = lista.map(cobrador => `
      <a href="/cobrador/${cobrador.username}" class="group bg-white rounded-2xl border border-slate-100 p-4 shadow-sm hover:shadow-lg hover:border-blue-200 transition-all block">
        <div class="flex items-center gap-3">
          <div class="bg-blue-100 group-hover:bg-blue-600 p-3 rounded-xl transition-colors">
            <svg class="w-5 h-5 text-blue-600 group-hover:text-white transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
            </svg>
          </div>
          <div class="flex-1">
            <h4 class="font-black text-slate-900 group-hover:text-blue-600 transition-colors">${cobrador.nombre}</h4>
            <p class="text-xs text-slate-400 font-bold">@${cobrador.username}</p>
          </div>
          <svg class="w-5 h-5 text-slate-300 group-hover:text-blue-600 group-hover:translate-x-1 transition-all" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
          </svg>
        </div>
      </a>
    `).join('');
  }

  // 6. LOGOUT
  const logoutBtn = document.getElementById('logout-btn');
  if (logoutBtn) {
    logoutBtn.onclick = () => {
      localStorage.removeItem('currentUser');
      localStorage.clear();
      navigate('/');
    };
  }

  // INICIALIZACIÓN
  if (checkAuth()) {
    setupUI();
    fetchData();
  }

  // Re-verificar después de transiciones de página
  document.addEventListener('astro:page-load', () => {
    if (checkAuth()) {
      setupUI();
      fetchData();
    }
  });
</script>