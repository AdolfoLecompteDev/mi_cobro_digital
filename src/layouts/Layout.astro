---
import '../styles/global.css';
import { Icon } from 'astro-icon/components';
import { ViewTransitions } from 'astro:transitions';

interface Props {
  title: string;
}

const { title } = Astro.props;
---
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <title>{title} | CobroDigital</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <ViewTransitions />
  </head>
  <body class="bg-[#fcfdfe] min-h-screen font-['Plus_Jakarta_Sans',sans-serif] text-slate-900 selection:bg-blue-100 selection:text-blue-700">
    
    <header class="sticky top-0 z-[100] w-full px-6 py-4">
      <nav class="max-w-7xl mx-auto bg-white/80 backdrop-blur-xl border border-white shadow-lg shadow-slate-200/40 rounded-[2rem] px-8 py-4 flex justify-between items-center transition-all duration-300" id="main-nav">
        
        <a href="/dashboard" class="flex items-center gap-3 group">
          <div class="relative">
            <div class="absolute -inset-1 bg-blue-600 rounded-xl blur opacity-20 group-hover:opacity-40 transition duration-500"></div>
            <div class="relative bg-slate-900 p-2 rounded-xl text-white group-hover:scale-105 transition-transform">
              <Icon name="lucide:gem" class="w-5 h-5" />
            </div>
          </div>
          <div class="flex flex-col">
            <span class="font-black text-lg tracking-tighter leading-none">
              Cobro<span class="text-blue-600">Digital</span>
            </span>
            <span class="text-[8px] font-black uppercase tracking-[0.3em] text-slate-400 mt-0.5">Cartera v2.0</span>
          </div>
        </a>

        <div class="flex items-center gap-4">
           <div id="nav-actions" class="hidden md:flex items-center gap-2 pr-4 border-r border-slate-100">
              </div>
           
           <div id="user-display" class="hidden flex items-center gap-3 pl-2">
              <div class="text-right hidden sm:block">
                <p id="nav-user-name" class="text-xs font-black text-slate-900 leading-none">Cargando...</p>
                <p id="nav-user-role" class="text-[9px] font-bold text-blue-500 uppercase tracking-widest mt-1">Status</p>
              </div>
              <div class="w-10 h-10 bg-slate-100 rounded-full border-2 border-white shadow-sm flex items-center justify-center text-slate-400">
                <Icon name="lucide:user" class="w-5 h-5" />
              </div>
           </div>
        </div>
      </nav>
    </header>

    <main class="max-w-7xl mx-auto px-6 animate-in fade-in duration-700">
      <slot />
    </main>

    <footer class="max-w-7xl mx-auto px-6 py-12 mt-20 border-t border-slate-100">
      <div class="flex flex-col md:flex-row justify-between items-center gap-6">
        <div class="flex items-center gap-2 opacity-50 grayscale hover:grayscale-0 transition-all cursor-default">
            <Icon name="lucide:gem" class="w-4 h-4 text-slate-900" />
            <span class="font-black text-sm tracking-tighter">CobroDigital</span>
        </div>
        
        <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.2em]">
          &copy; 2026 Todos los derechos reservados
        </p>

        <div class="flex gap-6">
          <a href="#" class="text-slate-400 hover:text-blue-600 transition-colors"><Icon name="lucide:shield-check" class="w-5 h-5" /></a>
          <a href="#" class="text-slate-400 hover:text-blue-600 transition-colors"><Icon name="lucide:help-circle" class="w-5 h-5" /></a>
        </div>
      </div>
    </footer>

    <script>
      function initLayout() {
        const userDisplay = document.getElementById('user-display');
        const navUserName = document.getElementById('nav-user-name');
        const navUserRole = document.getElementById('nav-user-role');
        
        const rawData = localStorage.getItem('currentUser');
        
        if (!rawData || rawData === 'undefined' || rawData === 'null') {
          if (userDisplay) userDisplay.classList.add('hidden');
          return; 
        }

        try {
          const user = JSON.parse(rawData);
          
          if (user && (user.nombre || user.username) && userDisplay) {
            userDisplay.classList.remove('hidden');
            if (navUserName) navUserName.innerText = user.nombre || user.username;
            if (navUserRole) navUserRole.innerText = user.role || 'Usuario';
          }
        } catch (e) {
          console.error("Error leyendo sesión en Layout");
          if (userDisplay) userDisplay.classList.add('hidden');
        }
      }

      // Ejecutar al cargar inicialmente
      initLayout();

      // Re-ejecutar después de cada navegación
      document.addEventListener('astro:page-load', () => {
        initLayout();
      });

      // Efecto de scroll optimizado
      let lastScroll = 0;
      function handleScroll() {
        const now = window.scrollY;
        if (Math.abs(now - lastScroll) < 10) return;
        lastScroll = now;

        const nav = document.getElementById('main-nav');
        if (!nav) return;

        if (now > 20) {
          nav.classList.add('shadow-xl', 'shadow-blue-900/5', 'py-3');
          nav.classList.remove('py-4');
        } else {
          nav.classList.remove('shadow-xl', 'shadow-blue-900/5', 'py-3');
          nav.classList.add('py-4');
        }
      }

      window.addEventListener('scroll', handleScroll, { passive: true });
    </script>
  </body>
</html>

<style is:global>
  :root {
    --accent: 37, 99, 235;
  }
  
  html {
    scroll-behavior: smooth;
    background: #fcfdfe;
  }

  body {
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    overflow-x: hidden;
  }

  ::-webkit-scrollbar {
    width: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 10px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #94a3b8;
  }

  .animate-in {
    animation-duration: 0.5s;
    animation-fill-mode: both;
  }
  @keyframes fade-in {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
</style>